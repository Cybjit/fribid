#!/bin/sh

prefix="/usr/local"
execprefix=""

error=""

basedir=`dirname "$0"`

while [ "$#" != "0" ]; do
    flag="$1"
    shift
    case "$flag" in
    --help)
        # TODO
        exit 0
        ;;
    --prefix=*)
        prefix=${flag#--prefix=}
        ;;
    --exec-prefix=*)
        execprefix=${flag#--exec-prefix=}
        ;;
    *)
        echo "Invalid option: $flag"
        error=1
        ;;
    esac
done

if [ ! -r "$basedir/common/defines.h" ]; then
    echo "Source code not found."
    error=1
fi

if [ -n "$error" ]; then
    exit 2
fi

prefixPath="$prefix"

if [ -z "$execprefix" ]; then
    execPath="$prefix"
else
    execPath="$execprefix"
fi

echo "Prefix: $prefixPath"
if [ -n "$execprefix" ]; then
    echo "Executable/library prefix: $execPath"
fi

CONFFILE="$basedir/common/config.h"

echo "
/* This file is automatically generated.
   Run the configure script to change the configuration. */

#define PREFIX \"$prefixPath\"
#define EPREFIX \"$execPath\"
" > $CONFFILE


cancreate() {
    if [ -w "$1" ]; then
        return 0
    elif [ ! -e "$1" ]; then
        cancreate `dirname "$1"`
        return $?
    else
        return 1
    fi
}

if cancreate "$prefixPath" && cancreate "$execPath"; then
    INSTALLCMD="make install"
else
    INSTALLCMD="sudo make install"
fi

echo "Wrote $CONFFILE."
echo "Type \`\`make'' to compile, and then \`\`$INSTALLCMD'' to install."

